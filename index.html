<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scenario</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;margin:0;padding:0}
    .wrap{max-width:900px;margin:24px auto;padding:16px}
    .box{border:1px solid #e2e8f0;border-radius:12px;padding:16px}
    .row{margin:.5rem 0}
    button{padding:.6rem 1rem;border-radius:8px;border:1px solid #94a3b8;background:#0ea5e9;color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    code{background:#f1f5f9;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Scenario (GitHub Pages)</h1>

    <!-- Your iSpring/game embed would usually be here -->
    <!-- e.g. <script src="data/browsersupport.js"></script> etc. -->

    <div class="box">
      <div class="row"><strong>Status:</strong> <span id="status">Idle</span></div>
      <div class="row"><strong>Last request:</strong> <span id="last"></span></div>
      <div class="row">
        <!-- TEST button so you can verify logging without finishing the course -->
        <button id="simulateBtn">Simulate Complete (85%, 12/15)</button>
      </div>
      <div class="row">
        Tip: You can prefill identity via query: <code>?user=Test%20User&email=test%40example.com&course=Role-Play%20Smoke%20Test</code>
      </div>
    </div>
  </div>

  <script>
    /***** 1) Configure your Apps Script Web App endpoint *****/
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzuJf2RSMA5O5oeD9wDba-0BEp0yiy67K-arnCmuyGFVnUhExWqUzBWJqGyUhdNUbgo8A/exec';

    /***** 2) Helpers: get identity from query string (or prompt as fallback) *****/
    function getIdentity() {
      const q = new URLSearchParams(location.search);
      const identity = {
        user: q.get('user') || '',
        email: q.get('email') || '',
        course: q.get('course') || document.title || 'Scenario'
      };
      return identity;
    }

    /***** 3) The logger: sends a GET as an <img> beacon (no CORS headaches) *****/
    function logScoreToSheet({ user, email, pct, raw, max, course }) {
      const qs = new URLSearchParams({
        user: user || '',
        email: email || '',
        pct: String(pct ?? ''),
        raw: String(raw ?? ''),
        max: String(max ?? ''),
        course: course || '',
        source: 'github-pages',
        _: Date.now().toString()   // cache buster
      });

      // Fire-and-forget image beacon
      const img = new Image();
      img.src = `${ENDPOINT}?${qs.toString()}`;

      // Optional UI feedback
      const $status = document.getElementById('status');
      const $last = document.getElementById('last');
      if ($status) $status.textContent = 'Sent (beacon)';
      if ($last) $last.textContent = img.src;
    }

    /***** 4) Public API your game/iSpring should call on completion *****/
    // Call this from your course end handler: window.onCourseComplete(pct, raw, max)
    window.onCourseComplete = function(pct, raw, max) {
      const id = getIdentity();
      logScoreToSheet({ user: id.user, email: id.email, course: id.course, pct, raw, max });
    };

    /***** 5) Test button to validate end-to-end without finishing the game *****/
    (function attachTester(){
      const btn = document.getElementById('simulateBtn');
      if (!btn) return;
      btn.addEventListener('click', () => {
        // Example numbers: 85% = 12/15
        window.onCourseComplete(85, 12, 15);
        btn.disabled = true;
        btn.textContent = 'Simulated ✓ — check your sheet';
      });
    })();
  </script>
</body>
</html>
